<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>College Lab Kiosk - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        .card-header {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border-radius: 20px 20px 0 0;
            color: white;
            padding: 30px;
            text-align: center;
        }
        .card-header h2 { margin: 0; font-size: 2rem; }
        .system-info {
            background: rgba(220, 53, 69, 0.1);
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-section { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-control {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        }
        .btn-login {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        .btn-secondary {
            background: #ffc107;
            border: none;
            color: #000;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: #ffb300;
            transform: translateY(-2px);
        }
        .session-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .session-modal.active {
            display: flex;
        }
        .session-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .session-card h1 {
            color: #28a745;
            margin-bottom: 20px;
        }
        .alert {
            display: none;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: 500;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- ERROR ALERT - Always visible at top -->
    <div id="errorAlert" class="alert">
        <strong>Error:</strong> <span id="errorMessage"></span>
    </div>

    <!-- LOGIN PAGE -->
    <div class="login-container">
        <div class="login-card">
            <div class="card-header">
                <h2><i class="fas fa-lock"></i> College Lab Kiosk</h2>
                <p class="mb-0">Secure Student Login</p>
            </div>

            <div class="system-info">
                <strong><i class="fas fa-info-circle"></i> System Information</strong>
                <div style="margin-top: 10px;">
                    <div>Computer: <strong id="computerName">Loading...</strong></div>
                    <div>Lab: <strong>CC1</strong></div>
                    <div>System Number: <strong id="systemNumber">CC1-01</strong></div>
                    <div>Current Time: <strong id="currentTime">--:--:--</strong></div>
                </div>
            </div>

            <div class="form-section">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-user"></i> <strong>Student ID</strong></label>
                        <input type="text" class="form-control" id="studentId" placeholder="Enter your Student ID" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-key"></i> <strong>Password</strong></label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                    </div>

                    <button type="submit" class="btn-login">
                        <i class="fas fa-unlock"></i> Login
                    </button>
                </form>

                <button type="button" class="btn-secondary" onclick="showForgotPassword()">
                    <i class="fas fa-key"></i> Forgot Password?
                </button>

                <button type="button" class="btn-secondary" onclick="showFirstTimeSignin()">
                    <i class="fas fa-user-plus"></i> First-time Sign-in
                </button>
            </div>
        </div>
    </div>

    <!-- Session Active & Screen Mirroring -->
    <div class="session-modal" id="sessionModal">
        <div class="session-card">
            <h1><i class="fas fa-check-circle"></i> Session Active!</h1>
            <p><strong>Welcome,</strong> <span id="sessionStudentName">Student</span></p>
            <p><strong>Student ID:</strong> <span id="sessionStudentId">---</span></p>
            <p><strong>System:</strong> <span id="sessionSystem">---</span></p>
            <p><strong>Login Time:</strong> <span id="sessionLoginTime">---</span></p>
            <button type="button" class="btn btn-danger btn-lg" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="session-modal" id="forgotPasswordModal">
        <div class="session-card">
            <h1><i class="fas fa-key"></i> Forgot Password</h1>
            <div id="forgotStep1">
                <p>Enter your Student ID:</p>
                <input type="text" class="form-control mb-3" id="forgotStudentId" placeholder="Student ID">
                <button type="button" class="btn btn-primary w-100" onclick="forgotPasswordStep2()">Next</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
            <div id="forgotStep2" style="display:none;">
                <p>Enter your college email address:</p>
                <input type="email" class="form-control mb-2" id="forgotEmail" placeholder="yourname@psgitech.ac.in">
                <small class="text-muted" style="display: block; margin-bottom: 12px;">
                    <i class="fas fa-info-circle"></i> Only @psgitech.ac.in emails are accepted
                </small>
                <button type="button" class="btn btn-primary w-100" onclick="sendOTP()">Send OTP</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
            <div id="forgotStep3" style="display:none;">
                <p>Enter OTP and new password:</p>
                <input type="text" class="form-control mb-2" id="otpCode" placeholder="OTP Code" maxlength="6">
                <input type="password" class="form-control mb-2" id="newPassword" placeholder="New Password">
                <input type="password" class="form-control mb-3" id="confirmPassword" placeholder="Confirm Password">
                <button type="button" class="btn btn-primary w-100" onclick="verifyOTP()">Reset Password</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- First-time Sign-in Modal -->
    <div class="session-modal" id="firstTimeModal">
        <div class="session-card">
            <h1><i class="fas fa-user-plus"></i> First-time Sign-in</h1>
            <form id="firstTimeForm">
                <div class="form-group">
                    <label class="form-label">Student ID:</label>
                    <input type="text" class="form-control" id="ftStudentId" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email:</label>
                    <input type="email" class="form-control" id="ftEmail" placeholder="yourname@psgitech.ac.in" required>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Only @psgitech.ac.in emails are accepted
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date of Birth:</label>
                    <input type="date" class="form-control" id="ftDOB" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password:</label>
                    <input type="password" class="form-control" id="ftPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password:</label>
                    <input type="password" class="form-control" id="ftConfirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Create Account</button>
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="showLoginPage()">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        console.log('‚úÖ Student interface loaded');

        let socket = null;
        let pc = null;
        let remoteVideo = null;

        // Initialize Socket.io for guest mode and screen mirroring
        function initializeSocket() {
            try {
                if (!window.electronAPI || !window.electronAPI.getServerUrl) {
                    console.log('‚ö†Ô∏è window.electronAPI not available');
                    return;
                }
                
                window.electronAPI.getServerUrl().then(serverUrl => {
                    console.log(`üì° Connecting to server: ${serverUrl}`);
                    socket = io(serverUrl, {
                        reconnection: true,
                        transports: ['websocket', 'polling']
                    });

                    // üé´ REGISTER KIOSK WITH SERVER (for pre-login state)
                    socket.on('connect', () => {
                        const systemNumber = document.getElementById('systemNumber')?.textContent || 'CC1-01';
                        console.log(`üé´ KIOSK: Registering with server (pre-login) - System: ${systemNumber}`);
                        socket.emit('register-kiosk', {
                            sessionId: null,  // Will be updated after login
                            systemNumber: systemNumber,
                            labId: 'CC1'  // Default lab
                        });
                    });

                    // üîì GUEST ACCESS / BYPASS LOGIN
                    socket.on('enable-guest-access', async (data) => {
                        const currentSystem = document.getElementById('systemNumber')?.textContent || 'CC1-01';
                        console.log('üîì Guest access command received for:', data.systemNumber, '| Current system:', currentSystem);
                        
                        // Check if this command is for this system
                        if (data.systemNumber === currentSystem) {
                            console.log('‚úÖ System match! Enabling guest access...');
                            await handleGuestAccess(data);
                        } else {
                            console.log('‚è≠Ô∏è Command not for this system, ignoring');
                        }
                    });

                    socket.on('guest-access-granted', (data) => {
                        console.log('üîì Guest access event received');
                        handleGuestMode(data);
                    });

                    // Screen mirroring: admin offer for WebRTC
                    socket.on('admin-offer', async (data) => {
                        console.log('üìπ Admin offer received for screen mirroring');
                        try {
                            await handleAdminOffer(data);
                        } catch (error) {
                            console.error('‚ùå Error handling admin offer:', error);
                        }
                    });

                    // ICE candidates for WebRTC
                    socket.on('webrtc-ice-candidate', (data) => {
                        if (pc && data.candidate) {
                            pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                                .catch(e => console.error('‚ùå Error adding ICE candidate:', e));
                        }
                    });

                    // Session ended by admin or automatic timetable
                    socket.on('session-ended', (data) => {
                        console.log('‚è≥ Session ended notification received:', data);
                        handleSessionEnded(data);
                    });

                    // Lab session ended (automatic timetable end)
                    socket.on('lab-session-ended', (data) => {
                        console.log('‚è≥ Lab session ended:', data);
                        handleSessionEnded(data);
                    });

                }).catch(err => console.error('‚ùå Error getting server URL:', err));
            } catch (error) {
                console.error('‚ùå Socket error:', error);
            }
        }

        async function handleAdminOffer(data) {
            console.log('üìπ KIOSK: Handling admin offer for screen mirroring');
            const { offer, sessionId, adminSocketId } = data;
            console.log('üìπ KIOSK: Offer params:', { hasOffer: !!offer, sessionId, adminSocketId });
            
            try {
                // Close existing peer connection if any
                if (pc) {
                    console.log('üîÑ KIOSK: Closing existing peer connection before creating new one');
                    pc.close();
                    pc = null;
                }
                
                // Create new peer connection
                console.log('üîó KIOSK: Creating new peer connection');
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                });

                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate && socket) {
                        socket.emit('webrtc-ice-candidate', {
                            candidate: event.candidate,
                            sessionId: sessionId
                        });
                    }
                };

                // Set remote description
                await pc.setRemoteDescription(new RTCSessionDescription(offer));

                // üé• CAPTURE DESKTOP SCREEN
                console.log('üé• KIOSK: Attempting screen capture via getDisplayMedia...');
                let displayStream = null;
                
                try {
                    // First try: navigator.mediaDevices.getDisplayMedia (standard method, Electron 22+)
                    displayStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always'
                        },
                        audio: false
                    });
                    console.log('‚úÖ KIOSK: getDisplayMedia() succeeded');
                } catch (error1) {
                    console.warn('‚ö†Ô∏è KIOSK: getDisplayMedia failed, trying alternative approach:', error1.message);
                    
                    // Second try: Use desktopCapturer sources with getUserMedia
                    try {
                        const sources = await window.electronAPI.getScreenSources();
                        console.log(`üì∫ KIOSK: Got ${sources.length} screen sources`);

                        if (sources.length === 0) {
                            throw new Error('No screen sources available');
                        }

                        // Use the primary screen
                        const screenSource = sources[0];
                        console.log(`üì∫ KIOSK: Using screen source: ${screenSource.name} (ID: ${screenSource.id})`);

                        displayStream = await navigator.mediaDevices.getUserMedia({
                            audio: false,
                            video: {
                                mandatory: {
                                    chromeMediaSource: 'desktop',
                                    chromeMediaSourceId: screenSource.id
                                }
                            }
                        });
                        console.log('‚úÖ KIOSK: getUserMedia with chromeMediaSource succeeded');
                    } catch (error2) {
                        console.error('‚ùå KIOSK: Both methods failed');
                        console.error('  Method 1 (getDisplayMedia):', error1.message);
                        console.error('  Method 2 (getUserMedia+chrome):', error2.message);
                        throw new Error(`Screen capture failed: ${error1.message}`);
                    }
                }

                console.log('‚úÖ KIOSK: Screen captured successfully');
                console.log('‚úÖ KIOSK: Captured tracks:', displayStream.getTracks().length);

                // Add video tracks to peer connection
                displayStream.getVideoTracks().forEach((track) => {
                    console.log('üìπ KIOSK: Adding video track to peer connection:', track.label);
                    pc.addTrack(track, displayStream);
                });

                console.log('‚úÖ KIOSK: Video tracks added to peer connection');

                // Handle screen stop
                if (displayStream.getVideoTracks()[0]) {
                    displayStream.getVideoTracks()[0].onended = () => {
                        console.log('‚èπÔ∏è KIOSK: Screen capture stopped by user');
                        pc.close();
                    };
                }

                // Create answer
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                console.log('‚úÖ KIOSK: Answer created with media tracks');

                // Send answer back to admin
                console.log('üì§ KIOSK: Sending answer to admin:', { adminSocketId, sessionId });
                socket.emit('webrtc-answer', {
                    answer: answer,
                    adminSocketId: adminSocketId,
                    sessionId: sessionId
                });

                console.log('‚úÖ‚úÖ‚úÖ KIOSK: Answer sent to admin with video stream');
                console.log('‚úÖ If admin doesn\'t get this, check server forwarding!');
            } catch (error) {
                console.error('‚ùå KIOSK: Error in WebRTC handshake:', error);
                console.error('‚ùå KIOSK: Stack:', error.stack);
                if (socket) {
                    socket.emit('webrtc-error', {
                        error: error.message,
                        sessionId: sessionId
                    });
                }
            }
        }

        async function handleGuestMode(data) {
            console.log('üîì Activating guest mode');
            try {
                const systemNumber = document.getElementById('systemNumber').textContent;
                const result = await window.electronAPI.studentLogin({
                    studentId: 'GUEST',
                    password: 'admin123',
                    systemNumber,
                    isGuest: true
                });

                if (result.success) {
                    document.getElementById('sessionStudentName').textContent = 'Guest User';
                    document.getElementById('sessionStudentId').textContent = 'GUEST';
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    document.querySelector('.login-container').style.display = 'none';
                    document.getElementById('sessionModal').classList.add('active');
                }
            } catch (error) {
                console.error('‚ùå Guest mode error:', error);
            }
        }

        // üîì HANDLE GUEST ACCESS (Admin-initiated remote unlock)
        async function handleGuestAccess(data) {
            console.log('üîì ========================================');
            console.log('üîì GUEST ACCESS ACTIVATED BY ADMIN');
            console.log('üîì System:', data.systemNumber);
            console.log('üîì Enabled by:', data.enabledBy);
            console.log('üîì ========================================');

            try {
                const systemNumber = document.getElementById('systemNumber').textContent;
                
                // Hide login screen
                const loginContainer = document.querySelector('.login-container');
                if (loginContainer) {
                    loginContainer.style.display = 'none';
                }

                // Show guest session screen
                const sessionModal = document.getElementById('sessionModal');
                if (sessionModal) {
                    // Update session info with guest details
                    document.getElementById('sessionStudentName').textContent = 'üë§ Guest User';
                    document.getElementById('sessionStudentId').textContent = 'GUEST';
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    
                    sessionModal.classList.add('active');
                }

                // Show success message
                showError('üîì Guest Access Enabled by Admin - System Unlocked', 'success');

                // Notify Electron main process to release kiosk mode (minimize restrictions)
                if (window.electronAPI && window.electronAPI.studentLogin) {
                    const result = await window.electronAPI.studentLogin({
                        studentId: 'GUEST',
                        password: data.guestPassword || 'admin123',
                        systemNumber: systemNumber,
                        isGuest: true,
                        guestMode: true
                    });

                    console.log('‚úÖ Guest login result:', result);
                }

                // Confirm back to server that guest access is active
                if (socket && socket.connected) {
                    socket.emit('guest-access-confirmed', {
                        systemNumber: systemNumber,
                        studentInfo: {
                            studentId: 'GUEST',
                            studentName: 'Guest User',
                            systemNumber: systemNumber,
                            isGuest: true
                        }
                    });
                    console.log('‚úÖ Guest access confirmation sent to server');
                }

                // Add visual indicator that system is in guest mode
                const statusDiv = document.createElement('div');
                statusDiv.id = 'guest-mode-indicator';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: bold;
                    z-index: 99999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                statusDiv.textContent = 'üîì GUEST MODE - Unlocked by Admin';
                document.body.appendChild(statusDiv);

            } catch (error) {
                console.error('‚ùå Error activating guest access:', error);
                showError('‚ùå Failed to activate guest access', 'error');
            }
        }

        // Listen for session-created event from main process
        if (window.electronAPI && window.electronAPI.onSessionCreated) {
            window.electronAPI.onSessionCreated((data) => {
                console.log('üìπ Session created event received from main process:', data);
                
                // üé´ RE-REGISTER KIOSK WITH SESSION ID
                if (data.sessionId && socket && socket.connected) {
                    console.log(`üé´ KIOSK: Re-registering with sessionId: ${data.sessionId}`);
                    socket.emit('register-kiosk', {
                        sessionId: data.sessionId,
                        systemNumber: data.studentInfo.systemNumber,
                        labId: 'CC1'
                    });
                }
                
                // Note: Screen mirroring is handled in background for admin monitoring
                // No visual feedback needed for student
            });
        }

        // Time update
        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('currentTime');
            if (timeEl) timeEl.textContent = now.toLocaleTimeString();
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                if (!window.electronAPI || !window.electronAPI.getSystemInfo) {
                    console.log('‚ö†Ô∏è window.electronAPI not available');
                    return;
                }
                const sysInfo = await window.electronAPI.getSystemInfo();
                document.getElementById('computerName').textContent = sysInfo.hostname;
                document.getElementById('systemNumber').textContent = sysInfo.systemNumber || 'CC1-01';
                console.log(`‚úÖ System info loaded: ${sysInfo.hostname}`);
            } catch (error) {
                console.error(`‚ùå Error: ${error.message}`);
            }
        }

        // Start time updates
        updateTime();
        setInterval(updateTime, 1000);

        // Initialize
        setTimeout(() => {
            loadSystemInfo();
            initializeSocket();
        }, 300);

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            const password = document.getElementById('password').value;
            const systemNumber = document.getElementById('systemNumber').textContent;

            if (!studentId || !password) {
                showError('Please enter Student ID and Password');
                return;
            }

            console.log(`üîê Login attempt for: ${studentId}`);

            try {
                const result = await window.electronAPI.studentLogin({
                    studentId,
                    password,
                    systemNumber
                });

                if (result.success) {
                    console.log(`‚úÖ Login successful!`);
                    console.log(`üé´ KIOSK: Updating registration with sessionId: ${result.sessionId}`);
                    
                    // üé´ RE-REGISTER KIOSK WITH SESSION ID (for screen mirroring)
                    if (socket && socket.connected) {
                        socket.emit('register-kiosk', {
                            sessionId: result.sessionId,
                            systemNumber: systemNumber,
                            labId: 'CC1'  // Default lab
                        });
                    }
                    
                    document.getElementById('sessionStudentName').textContent = result.student.name;
                    document.getElementById('sessionStudentId').textContent = result.student.studentId;
                    document.getElementById('sessionSystem').textContent = systemNumber;
                    document.getElementById('sessionLoginTime').textContent = new Date().toLocaleTimeString();
                    document.querySelector('.login-container').style.display = 'none';
                    document.getElementById('sessionModal').classList.add('active');
                } else {
                    showError(result.error || 'Login failed');
                }
            } catch (error) {
                showError('Login error: ' + error.message);
            }
        });

        function showError(msg, type = 'error') {
            const alert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = msg;
            
            // Add/remove success class based on type
            alert.classList.remove('success');
            if (type === 'success') {
                alert.classList.add('success');
            }
            
            alert.classList.add('show');
            setTimeout(() => {
                alert.classList.remove('show');
                alert.classList.remove('success');
            }, 5000);
        }

        function showForgotPassword() {
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
            document.getElementById('forgotStep3').style.display = 'none';
        }

        function forgotPasswordStep2() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            if (!studentId) {
                showError('Please enter your Student ID');
                return;
            }
            document.getElementById('forgotStep1').style.display = 'none';
            document.getElementById('forgotStep2').style.display = 'block';
        }

        // Validate email domain
        function validateEmail(email) {
            const emailPattern = /^[^\s@]+@psgitech\.ac\.in$/i;
            return emailPattern.test(email);
        }

        async function sendOTP() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                showError('Please enter your email address');
                return;
            }

            // Validate email domain
            if (!validateEmail(email)) {
                showError('‚ùå Invalid email! Only @psgitech.ac.in emails are allowed');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                const response = await fetch(`${serverUrl}/api/forgot-password-send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, email })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('forgotStep2').style.display = 'none';
                    document.getElementById('forgotStep3').style.display = 'block';
                } else {
                    showError(data.error || 'Failed to send OTP');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function verifyOTP() {
            const studentId = document.getElementById('forgotStudentId').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            const otp = document.getElementById('otpCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!otp || !newPassword || !confirmPassword) {
                showError('Please fill all fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                const response = await fetch(`${serverUrl}/api/forgot-password-verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId, email, otp, newPassword })
                });
                const data = await response.json();

                if (data.success) {
                    // Close modal first
                    showLoginPage();
                    // Show success message
                    showError('‚úÖ Password reset successfully!', 'success');
                    // Auto-fill and auto-login after 1 second
                    setTimeout(() => {
                        document.getElementById('studentId').value = studentId;
                        document.getElementById('password').value = newPassword;
                        // Auto-submit login
                        document.querySelector('.login-form').dispatchEvent(new Event('submit'));
                    }, 1000);
                } else {
                    showError(data.error || 'OTP verification failed');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function showFirstTimeSignin() {
            document.querySelector('.login-container').style.display = 'none';
            document.getElementById('firstTimeModal').classList.add('active');
        }

        document.getElementById('firstTimeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const studentId = document.getElementById('ftStudentId').value.trim();
            const email = document.getElementById('ftEmail').value.trim();
            const dob = document.getElementById('ftDOB').value;
            const password = document.getElementById('ftPassword').value;
            const confirmPassword = document.getElementById('ftConfirmPassword').value;

            // Validate email domain
            if (!validateEmail(email)) {
                showError('‚ùå Invalid email! Only @psgitech.ac.in emails are allowed');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            try {
                const serverUrl = await window.electronAPI.getServerUrl();
                
                const requestData = { studentId, email, dateOfBirth: dob, newPassword: password };
                console.log('üîê First-time sign-in request:', requestData);
                
                const response = await fetch(`${serverUrl}/api/first-time-signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('üîê First-time sign-in response:', data);

                if (data.success) {
                    console.log('‚úÖ First-time sign-in successful!');
                    // Close modal first
                    showLoginPage();
                    // Show success message
                    showError('‚úÖ Password set successfully! Logging you in...', 'success');
                    // Auto-fill and auto-login after 1 second
                    setTimeout(() => {
                        document.getElementById('studentId').value = studentId;
                        document.getElementById('password').value = password;
                        // Auto-submit login
                        document.querySelector('.login-form').dispatchEvent(new Event('submit'));
                    }, 1000);
                } else {
                    console.error('‚ùå First-time sign-in failed:', data.error);
                    showError(data.error || 'Sign-in failed');
                }
            } catch (error) {
                console.error('‚ùå First-time sign-in error:', error);
                showError('Error: ' + error.message);
            }
        });

        function showLoginPage() {
            document.querySelector('.login-container').style.display = 'flex';
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('firstTimeModal').classList.remove('active');
            document.getElementById('sessionModal').classList.remove('active');
        }

        function handleSessionEnded(data) {
            console.log('üõë Session has ended by admin or automatic timetable');
            
            // Show alert notification
            showError('Session has ended. Please log out and the system will shut down.');
            
            // Show countdown timer for 60 seconds (1 minute)
            let secondsRemaining = 60;
            const countdownInterval = setInterval(() => {
                console.log(`‚è≥ Countdown: ${secondsRemaining} seconds remaining`);
                showError(`Session ended. Logout required. Auto-shutdown in ${secondsRemaining}s`);
                secondsRemaining--;
                
                if (secondsRemaining <= 0) {
                    clearInterval(countdownInterval);
                    console.log('‚è±Ô∏è Session end countdown complete. Performing logout...');
                    logout();
                }
            }, 1000);
            
            // If user clicks logout before countdown, clean logout
            const logoutBtn = document.querySelector('[onclick="logout()"]');
            if (logoutBtn) {
                const originalOnclick = logoutBtn.onclick;
                logoutBtn.onclick = () => {
                    clearInterval(countdownInterval);
                    originalOnclick();
                };
            }
        }

        function logout() {
            if (window.electronAPI && window.electronAPI.studentLogout) {
                window.electronAPI.studentLogout();
            }
            location.reload();
        }

        console.log('‚úÖ Application ready');
    </script>
</body>
</html>
